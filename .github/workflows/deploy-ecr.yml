# ChatGPT Gateway API (api_gpt_v1) - ECR & EC2 自動デプロイワークフロー
name: Deploy to Amazon ECR and EC2

# このワークフローが実行されるタイミング
on:
  # mainブランチにpushされた時に実行
  push:
    branches: [ "main" ]
  # 手動実行も可能にする
  workflow_dispatch:

# 環境変数
env:
  AWS_REGION: ap-southeast-2
  ECR_REPOSITORY: watchme-vibe-analysis-scorer
  SERVICE_NAME: vibe-analysis-scorer

# ジョブの定義
jobs:
  # ジョブ1: CI - ECRへのDockerイメージプッシュ
  deploy:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    
    steps:
    # ステップ1: コードのチェックアウト
    - name: Checkout code
      uses: actions/checkout@v4

    # ステップ2: AWS認証情報の設定
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # ステップ3: ECRへのログイン
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # ステップ4: Docker Buildxのセットアップ（マルチプラットフォーム対応）
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ステップ5: Dockerイメージのビルド、タグ付け、プッシュ（ARM64対応）
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # ARM64アーキテクチャ用にDockerイメージをビルド
        docker buildx build \
          --platform linux/arm64 \
          --push \
          -f Dockerfile.prod \
          -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
          -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest \
          .
        
        echo "✅ Image pushed to ECR:"
        echo "  - $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG"
        echo "  - $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest"

    # ステップ6: デプロイ成功通知
    - name: Deploy Success Notification
      if: success()
      run: |
        echo "🎉 Deployment to ECR succeeded!"
        echo "📦 Repository: ${{ env.ECR_REPOSITORY }}"
        echo "🏷️ Image Tag: ${{ github.sha }}"
        echo "📍 Region: ${{ env.AWS_REGION }}"

    # ステップ7: エラー時の通知
    - name: Deploy Failure Notification
      if: failure()
      run: |
        echo "❌ Deployment to ECR failed!"
        echo "Please check the logs above for details."

  # ジョブ2: CD - EC2への自動デプロイ
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    # 重要: deploy ジョブが成功した後にのみ実行
    needs: deploy
    
    steps:
    # ステップ1: SSHエージェントのセットアップ
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    # ステップ2: Known Hostsの追加（セキュリティ向上）
    - name: Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 3.24.16.82 >> ~/.ssh/known_hosts
    
    # ステップ3: EC2にデプロイ
    - name: Deploy to EC2 instance
      run: |
        echo "🚀 Starting deployment to EC2..."
        
        # SSHでEC2に接続してデプロイコマンドを実行
        ssh ubuntu@3.24.16.82 << 'ENDSSH'
          set -e
          echo "📦 Starting deployment..."
          
          # 既存のコンテナを停止・削除
          echo "🛑 Stopping existing container..."
          docker rm -f vibe-analysis-scorer 2>/dev/null || true

          # ECRにログイン
          echo "🔐 Logging in to ECR..."
          aws ecr get-login-password --region ap-southeast-2 | \
            docker login --username AWS --password-stdin 754724220380.dkr.ecr.ap-southeast-2.amazonaws.com

          # 最新イメージをプル
          echo "📥 Pulling latest image..."
          docker pull 754724220380.dkr.ecr.ap-southeast-2.amazonaws.com/watchme-vibe-analysis-scorer:latest

          # systemdサービスを再起動
          echo "🔄 Restarting service..."
          sudo systemctl restart vibe-analysis-scorer

          # サービスの状態確認
          echo "📊 Checking service status..."
          sleep 5
          if sudo systemctl is-active --quiet vibe-analysis-scorer; then
            echo "✅ Service vibe-analysis-scorer is running"
          else
            echo "❌ Service vibe-analysis-scorer failed to start"
            sudo journalctl -u vibe-analysis-scorer -n 50
            exit 1
          fi
          
          # ヘルスチェック
          echo "🏥 Running health check..."
          sleep 3
          if curl -f http://localhost:8002/health; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi
        ENDSSH
        
        echo "✅ EC2 deployment completed successfully!"
    
    # ステップ4: 外部URLの検証
    - name: Verify External URL
      run: |
        echo "🔍 Verifying external URL..."
        sleep 5
        if curl -f https://api.hey-watch.me/vibe-scorer/health; then
          echo "✅ External URL is accessible"
          curl https://api.hey-watch.me/vibe-scorer/health | jq .
        else
          echo "❌ External URL verification failed"
          exit 1
        fi
    
    # ステップ5: デプロイ成功通知
    - name: Deployment Success Notification
      if: success()
      run: |
        echo "🎉 Full CI/CD pipeline completed successfully!"
        echo "📦 Service: ${{ env.SERVICE_NAME }}"
        echo "🌐 URL: https://api.hey-watch.me/vibe-scorer/"
        echo "🏷️ Version: ${{ github.sha }}"
        echo "📊 Features deployed:"
        echo "  - burst_events field saving to dashboard_summary"
        echo "  - cumulative_evaluation saved to insights column"
    
    # ステップ6: デプロイ失敗通知
    - name: Deployment Failure Notification
      if: failure()
      run: |
        echo "❌ EC2 deployment failed!"
        echo "Please check the SSH connection and server logs."